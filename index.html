<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>西北社區QR Code報到系統</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- QR Code generation library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <!-- QR Code scanning library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', '微軟正黑體', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .tab-button {
            @apply px-4 py-2 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-blue-600 hover:border-blue-600 focus:outline-none;
        }
        .tab-button.active {
            @apply text-blue-600 border-blue-600;
        }
        #reader {
            width: 100%;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        /* Custom animation for feedback messages */
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        .feedback-animation {
            animation: fadeInOut 3s ease-in-out forwards;
        }
        /* Print-friendly styles for QR codes */
        @media print {
            body * {
                visibility: hidden;
            }
            #qr-code-print-area, #qr-code-print-area * {
                visibility: visible;
            }
            #qr-code-print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .qr-code-item {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container" class="w-full max-w-4xl mx-auto bg-white shadow-lg rounded-lg overflow-hidden my-4">

        <!-- ===== Login View ===== -->
        <div id="login-view" class="p-8">
            <div class="text-center mb-8">
                <i class="fas fa-qrcode text-5xl text-red-600"></i>
                <h1 class="text-3xl font-bold text-gray-800 mt-4">西北社區QR Code報到系統</h1>
            </div>
            
            <div class="max-w-sm mx-auto">
                <div class="mb-4">
                    <div class="flex justify-between items-center">
                        <label for="account" class="block text-sm font-medium text-gray-700">登入帳號</label>
                        <div class="flex items-center">
                            <input id="remember-me" type="checkbox" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                            <label for="remember-me" class="ml-2 block text-sm text-gray-700">記住我</label>
                        </div>
                    </div>
                    <input type="text" id="account" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" placeholder="請輸入英數字帳號">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700">密碼</label>
                    <div class="relative mt-1">
                        <input type="password" id="password" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 pr-10" placeholder="********">
                        <button type="button" id="toggle-password-visibility" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 hover:text-gray-700 focus:outline-none">
                            <i class="fas fa-eye" id="password-toggle-icon"></i>
                        </button>
                    </div>
                </div>
                <div id="auth-error" class="text-red-500 text-sm mb-4 text-center hidden"></div>
                <div class="flex flex-col sm:flex-row gap-2">
                    <button id="login-btn" class="w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out">登入</button>
                </div>
            </div>
        </div>

        <!-- ===== Community Selection View ===== -->
        <div id="community-selection-view" class="p-8 hidden">
            <header class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">選擇社區</h1>
                <button id="logout-btn-main" class="text-gray-500 hover:text-red-600 focus:outline-none">
                    <i class="fas fa-sign-out-alt mr-1"></i>登出
                </button>
            </header>
            
            <div id="community-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <!-- Community cards will be inserted here -->
                <div id="loading-communities" class="text-center p-4 text-gray-500 col-span-full">正在載入您的社區...</div>
            </div>

            <div class="bg-gray-50 p-6 rounded-lg">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">建立新社區</h2>
                <form id="create-community-form" class="flex items-end gap-4">
                    <div class="flex-grow">
                        <label for="new-community-name" class="block text-sm font-medium text-gray-700">新社區名稱</label>
                        <input type="text" id="new-community-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <button type="submit" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:bg-gray-400">建立</button>
                </form>
                <div id="create-community-error" class="text-red-500 text-sm mt-2"></div>
            </div>
        </div>

        <!-- ===== Main App View (Community Specific) ===== -->
        <div id="main-view" class="hidden">
            <!-- Header -->
            <header class="bg-gray-50 p-4 border-b flex justify-between items-center">
                <div>
                    <h2 id="header-community-name" class="text-xl font-bold text-gray-800">社區名稱</h2>
                    <p id="header-event-name" class="text-sm text-gray-500">會議活動</p>
                </div>
                <div>
                    <button id="back-to-communities-btn" class="text-sm text-gray-600 hover:text-blue-600 mr-4"><i class="fas fa-arrow-left mr-1"></i>返回社區列表</button>
                    <button id="logout-btn" class="text-gray-500 hover:text-red-600 focus:outline-none">
                        <i class="fas fa-sign-out-alt mr-1"></i>登出
                    </button>
                </div>
            </header>

            <!-- Tabs -->
            <nav class="border-b">
                <div class="flex -mb-px px-4" id="tabs">
                    <button data-tab="setup" class="tab-button active"><i class="fas fa-cog mr-2"></i>活動設定</button>
                    <button data-tab="residents" class="tab-button"><i class="fas fa-users mr-2"></i>住戶管理</button>
                    <button data-tab="scanner" class="tab-button"><i class="fas fa-qrcode mr-2"></i>掃碼報到</button>
                    <button data-tab="status" class="tab-button"><i class="fas fa-chart-pie mr-2"></i>報到狀況</button>
                    <button data-tab="users" class="tab-button"><i class="fas fa-user-plus mr-2"></i>帳號管理</button>
                </div>
            </nav>

            <!-- Tab Content -->
            <main id="tab-content" class="p-6" style="min-height: 60vh;">
                <!-- Setup Tab -->
                <div id="setup-tab" class="tab-pane">
                     <h3 class="text-2xl font-semibold mb-4 text-gray-700">活動設定</h3>
                    <div class="space-y-4 max-w-lg">
                        <div>
                            <label for="community-name-display" class="block text-sm font-medium text-gray-700">目前管理的社區</label>
                            <input type="text" id="community-name-display" class="mt-1 block w-full px-3 py-2 border bg-gray-100 border-gray-300 rounded-md" readonly>
                        </div>
                        <div>
                            <label for="event-name" class="block text-sm font-medium text-gray-700">會議/活動名稱</label>
                            <input type="text" id="event-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="event-date" class="block text-sm font-medium text-gray-700">日期與時間</label>
                            <input type="datetime-local" id="event-date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <button id="save-config-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">儲存設定</button>
                        <p id="config-feedback" class="text-green-600 text-sm mt-2"></p>
                    </div>
                </div>

                <!-- Residents Tab -->
                <div id="residents-tab" class="tab-pane hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-semibold text-gray-700">住戶管理</h3>
                        <button id="view-qrcodes-btn" class="bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"><i class="fas fa-print mr-2"></i>產生 & 列印 QR Code</button>
                    </div>
                    <!-- Add Resident Form -->
                    <div class="bg-gray-50 p-4 rounded-lg mb-6">
                        <h4 class="font-semibold mb-2">新增住戶</h4>
                        <form id="add-resident-form" class="flex flex-col sm:flex-row gap-4 items-end">
                            <div class="flex-grow w-full">
                                <label for="resident-household" class="block text-sm font-medium text-gray-700">戶號 (例如: A-101)</label>
                                <input type="text" id="resident-household" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <div class="flex-grow w-full">
                                <label for="resident-name" class="block text-sm font-medium text-gray-700">住戶姓名</label>
                                <input type="text" id="resident-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <button type="submit" class="w-full sm:w-auto bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">新增</button>
                        </form>
                    </div>
                    <!-- Resident List -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="text-left py-3 px-4 font-semibold text-sm">戶號</th>
                                    <th class="text-left py-3 px-4 font-semibold text-sm">姓名</th>
                                    <th class="text-left py-3 px-4 font-semibold text-sm">操作</th>
                                </tr>
                            </thead>
                            <tbody id="resident-list" class="text-gray-700"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Scanner Tab -->
                <div id="scanner-tab" class="tab-pane hidden">
                     <div class="flex flex-col md:flex-row gap-6">
                        <div class="w-full md:w-1/2">
                            <h3 class="text-2xl font-semibold mb-2 text-gray-700">掃碼報到</h3>
                            <p class="text-gray-500 mb-4">將住戶的 QR code 對準下方掃描框</p>
                            <div id="reader-container" class="relative">
                                <div id="reader"></div>
                                <div id="feedback-overlay" class="absolute inset-0 flex items-center justify-center pointer-events-none"></div>
                            </div>
                            <div id="scanner-error" class="text-red-500 mt-2"></div>
                            <button id="stop-scanner-btn" class="hidden mt-4 w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700">停止掃描</button>
                        </div>
                        <div class="w-full md:w-1/2">
                            <h4 class="text-xl font-semibold mb-4 text-gray-700">最近報到紀錄</h4>
                            <div id="scan-log" class="space-y-2 h-96 overflow-y-auto bg-gray-50 p-3 rounded-lg"></div>
                        </div>
                    </div>
                </div>

                <!-- Status Tab -->
                <div id="status-tab" class="tab-pane hidden">
                    <h3 class="text-2xl font-semibold mb-4 text-gray-700">即時報到狀況</h3>
                    <div class="bg-gray-50 p-4 rounded-lg mb-6 shadow">
                        <div class="flex justify-around text-center">
                            <div>
                                <p class="text-sm text-gray-500">總戶數</p>
                                <p id="total-residents" class="text-3xl font-bold text-gray-800">0</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">已報到</p>
                                <p id="checked-in-count" class="text-3xl font-bold text-green-600">0</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">報到率</p>
                                <p id="check-in-percentage" class="text-3xl font-bold text-blue-600">0%</p>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-4">
                            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white rounded-lg shadow">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="text-left py-3 px-4 font-semibold text-sm">戶號</th>
                                    <th class="text-left py-3 px-4 font-semibold text-sm">姓名</th>
                                    <th class="text-left py-3 px-4 font-semibold text-sm">報到狀態</th>
                                    <th class="text-left py-3 px-4 font-semibold text-sm">報到時間</th>
                                </tr>
                            </thead>
                            <tbody id="status-list" class="text-gray-700"></tbody>
                        </table>
                    </div>
                </div>

                <!-- User Management Tab -->
                <div id="users-tab" class="tab-pane hidden">
                    <h3 class="text-2xl font-semibold mb-4 text-gray-700">後台帳號管理</h3>
                    <div class="bg-gray-50 p-6 rounded-lg max-w-lg">
                        <h4 class="font-semibold mb-3 text-gray-800">建立新工作人員帳號</h4>
                        <form id="create-user-form" class="space-y-4">
                            <div>
                                <label for="new-account-name" class="block text-sm font-medium text-gray-700">新帳號 (僅限英數字)</label>
                                <input type="text" id="new-account-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <div>
                                <label for="new-account-password" class="block text-sm font-medium text-gray-700">新密碼 (至少6個字元)</label>
                                <input type="password" id="new-account-password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <button type="submit" class="w-full sm:w-auto bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:bg-gray-400">建立帳號</button>
                        </form>
                        <div id="create-user-feedback" class="text-sm mt-4"></div>
                    </div>
                     <div class="mt-6 p-4 border-l-4 border-yellow-400 bg-yellow-50 rounded">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fa fa-info-circle text-yellow-500"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-yellow-700">
                                    請注意：基於安全考量，此介面僅提供「新增」帳號功能。若需「查詢」或「刪除」帳號，請登入您的 Firebase 專案後台進行管理。
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>

        <!-- Modals and other hidden elements -->
        <div id="qrcode-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-5xl max-h-[90vh] flex flex-col">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="text-xl font-semibold">住戶 QR Code</h3>
                    <div>
                        <button id="print-qrcodes-btn" class="mr-2 bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700"><i class="fas fa-print mr-1"></i>列印</button>
                        <button id="close-qrcode-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button>
                    </div>
                </div>
                <div id="qr-code-print-area" class="p-6 overflow-y-auto">
                    <div id="qrcode-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
                </div>
            </div>
        </div>
        <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-sm p-6">
                <h3 id="confirm-modal-title" class="text-lg font-semibold text-gray-800 mb-4"></h3>
                <p id="confirm-modal-text" class="text-gray-600 mb-6"></p>
                <div class="flex justify-end gap-4">
                    <button id="confirm-modal-cancel-btn" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300">取消</button>
                    <button id="confirm-modal-ok-btn" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700"></button>
                </div>
            </div>
        </div>
        <div id="info-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-lg shadow-xl w-11/12 max-w-sm p-6 text-center">
                <h3 id="info-modal-title" class="text-lg font-semibold text-gray-800 mb-4"></h3>
                <p id="info-modal-text" class="text-gray-600 mb-6"></p>
                <div class="flex justify-center">
                    <button id="info-modal-ok-btn" class="bg-blue-600 text-white py-2 px-6 rounded-md hover:bg-blue-700">了解</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, onSnapshot, query, updateDoc, deleteDoc, serverTimestamp, where, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyA66MZ0dfxSrWgtCiIyNW4GjTo0n1s7psg",
          authDomain: "nwcom-qrcodecheckin.firebaseapp.com",
          projectId: "nwcom-qrcodecheckin",
          storageBucket: "nwcom-qrcodecheckin.firebasestorage.app",
          messagingSenderId: "700787049117",
          appId: "1:700787049117:web:13ccf14c5c41abff6b4a74",
          measurementId: "G-E857BJVJMD"
        };
        
        // --- App Initialization ---
        const loginView = document.getElementById('login-view');
        if (firebaseConfig.apiKey === "YOUR_API_KEY" || !firebaseConfig.apiKey) {
            loginView.innerHTML = `
                <div class="p-8 text-center bg-red-50 rounded-lg">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                    <h1 class="text-2xl font-bold text-red-700">下一步：請設定 Firebase</h1>
                    <p class="mt-2 text-gray-800">
                        您的報到系統尚未與後端資料庫連接。請依照先前提供的教學文件，完成 Firebase 設定，然後將專案的 
                        <code>firebaseConfig</code> 
                        設定碼貼入此 HTML 檔案中取代預留位置。
                    </p>
                </div>`;
        } else {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            // Secondary app for user creation to not interfere with admin's session
            const secondaryApp = initializeApp(firebaseConfig, "secondary-app-for-user-creation");
            const secondaryAuth = getAuth(secondaryApp);

            // --- Login UI Enhancements ---
            const passwordInput = document.getElementById('password');
            const togglePasswordBtn = document.getElementById('toggle-password-visibility');
            const passwordToggleIcon = document.getElementById('password-toggle-icon');

            togglePasswordBtn.addEventListener('click', () => {
                const isPassword = passwordInput.type === 'password';
                passwordInput.type = isPassword ? 'text' : 'password';
                passwordToggleIcon.classList.toggle('fa-eye', !isPassword);
                passwordToggleIcon.classList.toggle('fa-eye-slash', isPassword);
            });

            // Load saved account from localStorage
            const savedAccount = localStorage.getItem('qr-checkin-account');
            if (savedAccount) {
                document.getElementById('account').value = savedAccount;
                document.getElementById('remember-me').checked = true;
            }

            // --- DOM Elements ---
            const mainView = document.getElementById('main-view');
            const communitySelectionView = document.getElementById('community-selection-view');
            const authError = document.getElementById('auth-error');

            // --- State ---
            let currentUser = null;
            let selectedCommunityId = null;
            let selectedCommunityName = null;
            let communityUnsubscribe = null;
            let configUnsubscribe = null;
            let residentsUnsubscribe = null;
            let sessionUnsubscribe = null; // Listener for session management
            let html5QrCode = null;

            // --- App Flow & Navigation ---
            function showView(viewId) {
                ['login-view', 'community-selection-view', 'main-view'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(viewId).classList.remove('hidden');
            }

            function enterCommunity(communityId, communityName) {
                selectedCommunityId = communityId;
                selectedCommunityName = communityName;
                showView('main-view');
                document.getElementById('community-name-display').value = communityName;
                setupCommunityListeners();
                 // Reset tabs to default
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                document.querySelector('button[data-tab="setup"]').classList.add('active');
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
                document.getElementById('setup-tab').classList.remove('hidden');
            }

            function returnToCommunitySelection() {
                cleanupCommunityListeners();
                selectedCommunityId = null;
                selectedCommunityName = null;
                stopScanner();
                showView('community-selection-view');
            }

            document.getElementById('back-to-communities-btn').addEventListener('click', returnToCommunitySelection);

            // --- Authentication & Session Management ---
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    
                    const userStatusRef = doc(db, 'users', user.uid);
                    const localSessionId = crypto.randomUUID();
                    setDoc(userStatusRef, { sessionId: localSessionId, lastLogin: serverTimestamp() }, { merge: true });

                    if (sessionUnsubscribe) sessionUnsubscribe();
                    sessionUnsubscribe = onSnapshot(userStatusRef, (statusDoc) => {
                        if (statusDoc.exists()) {
                            const remoteSessionId = statusDoc.data().sessionId;
                            if (remoteSessionId && remoteSessionId !== localSessionId) {
                                signOut(auth).then(() => {
                                    showInfoModal('連線中斷', '此帳號已在其他裝置登入，您已被自動登出。');
                                });
                            }
                        }
                    });
                    
                    showView('community-selection-view');
                    setupCommunityListListener();
                } else {
                    currentUser = null;
                    cleanupCommunityListeners();
                    cleanupCommunityListListener();
                    if (sessionUnsubscribe) {
                        sessionUnsubscribe();
                        sessionUnsubscribe = null;
                    }
                    showView('login-view');
                }
            });
            
            async function handleLogout() {
                if (currentUser) {
                    const userStatusRef = doc(db, 'users', currentUser.uid);
                    await setDoc(userStatusRef, { sessionId: null }, { merge: true });
                }
                await signOut(auth);
            }

            [...document.querySelectorAll('#logout-btn, #logout-btn-main')].forEach(btn => {
                btn.addEventListener('click', handleLogout);
            });

            document.getElementById('login-btn').addEventListener('click', () => {
                authError.classList.add('hidden');
                const account = document.getElementById('account').value.trim();
                const password = document.getElementById('password').value;
                const rememberMe = document.getElementById('remember-me').checked;

                if (!account || !password) {
                    handleAuthError({ code: 'auth/invalid-input' }, authError);
                    return;
                }

                if (rememberMe) {
                    localStorage.setItem('qr-checkin-account', account);
                } else {
                    localStorage.removeItem('qr-checkin-account');
                }

                const email = `${account}@checkin.system`; // Append dummy domain
                signInWithEmailAndPassword(auth, email, password).catch(err => handleAuthError(err, authError));
            });
            
            function handleAuthError(error, errorElement) {
                console.error("Authentication Error:", error);
                errorElement.classList.remove('hidden');
                const errorMap = {
                    'auth/invalid-input': '帳號和密碼欄位不可空白。',
                    'auth/invalid-email': '帳號或密碼錯誤。', // Remapped for username context
                    'auth/user-not-found': '帳號或密碼錯誤。',
                    'auth/wrong-password': '帳號或密碼錯誤。',
                    'auth/email-already-in-use': '此帳號名稱已被使用。',
                    'auth/weak-password': '密碼強度不足，至少需要6個字元。',
                    'auth/operation-not-allowed': '登入方式未啟用。請聯絡系統管理員。'
                };
                errorElement.textContent = errorMap[error.code] || '發生未知錯誤，請稍後再試。';
            }

            // --- User Creation (in Admin Panel) ---
            document.getElementById('create-user-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const accountInput = document.getElementById('new-account-name');
                const passwordInput = document.getElementById('new-account-password');
                const button = form.querySelector('button[type="submit"]');
                const feedbackEl = document.getElementById('create-user-feedback');
                
                const account = accountInput.value.trim();
                const password = passwordInput.value;

                feedbackEl.textContent = '';
                feedbackEl.classList.remove('text-red-500', 'text-green-600');
                
                if (!account || !password) {
                    feedbackEl.textContent = '新帳號和新密碼欄位不可空白。';
                    feedbackEl.classList.add('text-red-500');
                    return;
                }
                
                // Simple validation for alphanumeric username
                if (!/^[a-zA-Z0-9]+$/.test(account)) {
                     feedbackEl.textContent = '帳號僅能包含英文字母和數字。';
                    feedbackEl.classList.add('text-red-500');
                    return;
                }

                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>建立中...';
                
                const newUserEmail = `${account}@checkin.system`;

                try {
                    await createUserWithEmailAndPassword(secondaryAuth, newUserEmail, password);
                    feedbackEl.textContent = `帳號 "${account}" 已成功建立！`;
                    feedbackEl.classList.add('text-green-600');
                    form.reset();
                } catch (error) {
                    // Use a temporary div to display creation error
                    const creationErrorDiv = document.createElement('div');
                    handleAuthError(error, creationErrorDiv);
                    feedbackEl.textContent = creationErrorDiv.textContent;
                    feedbackEl.classList.add('text-red-500');
                } finally {
                    button.disabled = false;
                    button.textContent = '建立帳號';
                }
            });

            // --- Community Management ---
            function setupCommunityListListener() {
                if (!currentUser) return;
                const membershipsRef = collection(db, 'users', currentUser.uid, 'communityMemberships');
                if (communityUnsubscribe) communityUnsubscribe(); 
                communityUnsubscribe = onSnapshot(membershipsRef, async (snapshot) => {
                    document.getElementById('loading-communities').style.display = 'block';
                    if (snapshot.empty) {
                        document.getElementById('community-list').innerHTML = '<p class="text-center text-gray-500 col-span-full">您尚未加入任何社區。請建立一個新社區開始使用。</p>';
                        document.getElementById('loading-communities').style.display = 'none';
                        return;
                    }

                    const communityPromises = snapshot.docs.map(docSnap => getDoc(doc(db, 'communities', docSnap.id)));
                    const communityDocs = await Promise.all(communityPromises);
                    
                    const communityListEl = document.getElementById('community-list');
                    communityListEl.innerHTML = '';
                    communityDocs.forEach(docSnap => {
                        if (docSnap.exists()) {
                            const community = { id: docSnap.id, ...docSnap.data() };
                            const card = document.createElement('div');
                            card.className = 'bg-white p-6 rounded-lg shadow border border-gray-200 hover:shadow-md hover:border-blue-500 cursor-pointer transition-all';
                            card.innerHTML = `
                                <div class="flex items-center mb-2">
                                    <i class="fas fa-building text-blue-500 text-2xl mr-4"></i>
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-800">${community.name}</h3>
                                        <p class="text-sm text-gray-400">ID: ${community.id}</p>
                                    </div>
                                </div>
                            `;
                            card.addEventListener('click', () => enterCommunity(community.id, community.name));
                            communityListEl.appendChild(card);
                        }
                    });
                    document.getElementById('loading-communities').style.display = 'none';
                });
            }
            
            function cleanupCommunityListListener() {
                if (communityUnsubscribe) {
                    communityUnsubscribe();
                    communityUnsubscribe = null;
                }
            }

            document.getElementById('create-community-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const input = form.querySelector('#new-community-name');
                const button = form.querySelector('button[type="submit"]');
                const communityName = input.value.trim();
                const errorEl = document.getElementById('create-community-error');
                errorEl.textContent = '';

                if (!communityName) {
                    errorEl.textContent = '社區名稱不可空白。';
                    return;
                }

                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>建立中...';

                try {
                    const batch = writeBatch(db);
                    const newCommunityRef = doc(collection(db, 'communities'));
                    
                    batch.set(newCommunityRef, {
                        name: communityName,
                        ownerId: currentUser.uid,
                        createdAt: serverTimestamp()
                    });

                    const membershipRef = doc(db, 'users', currentUser.uid, 'communityMemberships', newCommunityRef.id);
                    batch.set(membershipRef, { joinedAt: serverTimestamp() });

                    await batch.commit();
                    enterCommunity(newCommunityRef.id, communityName);

                } catch (error) {
                    console.error("Error creating community: ", error);
                    errorEl.textContent = '建立社區時發生錯誤，請稍後再試。';
                } finally {
                    button.disabled = false;
                    button.innerHTML = '建立';
                    input.value = '';
                }
            });


            // --- Community-Specific Data Listeners & Handlers ---
            function setupCommunityListeners() {
                if (!selectedCommunityId) return;
                const configRef = doc(db, 'communities', selectedCommunityId, 'eventConfig', 'current');
                const residentsColRef = collection(db, 'communities', selectedCommunityId, 'residents');

                if (configUnsubscribe) configUnsubscribe();
                configUnsubscribe = onSnapshot(configRef, (docSnap) => {
                    const configData = docSnap.exists() ? docSnap.data() : {};
                    updateConfigUI(configData);
                });

                if (residentsUnsubscribe) residentsUnsubscribe();
                residentsUnsubscribe = onSnapshot(query(residentsColRef), (snapshot) => {
                    const residents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    updateResidentsUI(residents);
                    updateStatusUI(residents);
                });
            }

            function cleanupCommunityListeners() {
                if (configUnsubscribe) { configUnsubscribe(); configUnsubscribe = null; }
                if (residentsUnsubscribe) { residentsUnsubscribe(); residentsUnsubscribe = null; }
            }

            document.getElementById('save-config-btn').addEventListener('click', async () => {
                const configRef = doc(db, 'communities', selectedCommunityId, 'eventConfig', 'current');
                const configData = {
                    eventName: document.getElementById('event-name').value,
                    eventDate: document.getElementById('event-date').value,
                };
                await setDoc(configRef, configData);
                const feedback = document.getElementById('config-feedback');
                feedback.textContent = '設定已成功儲存！';
                setTimeout(() => feedback.textContent = '', 3000);
            });

            document.getElementById('add-resident-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const residentsColRef = collection(db, 'communities', selectedCommunityId, 'residents');
                const householdInput = document.getElementById('resident-household');
                const nameInput = document.getElementById('resident-name');
                const newResident = {
                    householdId: householdInput.value.trim(),
                    name: nameInput.value.trim(),
                    isCheckedIn: false,
                    checkInTime: null,
                };
                if (newResident.householdId && newResident.name) {
                    await addDoc(residentsColRef, newResident);
                    householdInput.value = '';
                    nameInput.value = '';
                    householdInput.focus();
                }
            });

            document.getElementById('resident-list').addEventListener('click', async (e) => {
                const btn = e.target.closest('.delete-resident-btn');
                if (btn) {
                    const residentId = btn.dataset.id;
                    const residentRef = doc(db, 'communities', selectedCommunityId, 'residents', residentId);
                    const confirmed = await showConfirmModal('刪除住戶', '您確定要刪除這位住戶嗎？', '確定刪除');
                    if (confirmed) {
                        await deleteDoc(residentRef);
                    }
                }
            });

            // --- UI Update Functions ---
            function updateConfigUI(data) {
                document.getElementById('event-name').value = data.eventName || '';
                document.getElementById('event-date').value = data.eventDate || '';
                document.getElementById('header-community-name').textContent = selectedCommunityName;
                document.getElementById('header-event-name').textContent = data.eventName || '尚未設定活動';
            }

            function updateResidentsUI(residents) {
                const list = document.getElementById('resident-list');
                list.innerHTML = ''; 
                residents.sort((a,b) => a.householdId.localeCompare(b.householdId)).forEach(res => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="py-3 px-4">${res.householdId}</td>
                        <td class="py-3 px-4">${res.name}</td>
                        <td class="py-3 px-4">
                            <button data-id="${res.id}" class="delete-resident-btn text-red-500 hover:text-red-700"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    `;
                    list.appendChild(row);
                });
                updateQrCodeModal(residents);
            }
            
            function updateStatusUI(residents) {
                const total = residents.length;
                const checkedIn = residents.filter(r => r.isCheckedIn).length;
                const percentage = total > 0 ? Math.round((checkedIn / total) * 100) : 0;

                document.getElementById('total-residents').textContent = total;
                document.getElementById('checked-in-count').textContent = checkedIn;
                document.getElementById('check-in-percentage').textContent = `${percentage}%`;
                document.getElementById('progress-bar').style.width = `${percentage}%`;
                
                const list = document.getElementById('status-list');
                list.innerHTML = '';
                residents.sort((a,b) => a.householdId.localeCompare(b.householdId)).forEach(res => {
                    const checkInTime = res.checkInTime ? new Date(res.checkInTime.seconds * 1000).toLocaleTimeString('zh-TW') : '---';
                    const row = document.createElement('tr');
                    row.className = res.isCheckedIn ? 'bg-green-50' : '';
                    row.innerHTML = `
                        <td class="py-3 px-4">${res.householdId}</td>
                        <td class="py-3 px-4">${res.name}</td>
                        <td class="py-3 px-4"><span class="px-2 py-1 text-xs rounded-full ${res.isCheckedIn ? 'bg-green-200 text-green-800' : 'bg-gray-200 text-gray-800'}">${res.isCheckedIn ? '已報到' : '未報到'}</span></td>
                        <td class="py-3 px-4">${checkInTime}</td>
                    `;
                    list.appendChild(row);
                });
            }
            
            function updateQrCodeModal(residents) {
                const qrList = document.getElementById('qrcode-list');
                qrList.innerHTML = '';
                residents.sort((a,b) => a.householdId.localeCompare(b.householdId)).forEach(res => {
                    const item = document.createElement('div');
                    item.className = 'qr-code-item border p-4 rounded-lg text-center flex flex-col items-center justify-center';
                    const qrContainer = document.createElement('div');
                    qrContainer.id = `qr-${res.id}`;
                    qrContainer.className = 'mb-2';
                    item.appendChild(qrContainer);
                    const info = document.createElement('p');
                    info.className = 'font-semibold';
                    info.textContent = `${res.householdId} ${res.name}`;
                    item.appendChild(info);
                    qrList.appendChild(item);
                    new QRCode(qrContainer, { text: res.id, width: 128, height: 128 });
                });
            }

            // --- Tabs, Scanner, Modals ---
            const tabs = document.getElementById('tabs');
            tabs.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (btn) {
                    const tabId = btn.dataset.tab;
                    tabs.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    document.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.toggle('hidden', pane.id !== `${tabId}-tab`);
                    });
                    if (tabId === 'scanner') startScanner();
                    else stopScanner();
                }
            });

            function startScanner() {
                if (html5QrCode && html5QrCode.isScanning) return;
                html5QrCode = new Html5Qrcode("reader");
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                document.getElementById('scanner-error').textContent = '正在啟動攝影機...';
                document.getElementById('stop-scanner-btn').classList.remove('hidden');
                html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, (err) => {})
                    .then(() => document.getElementById('scanner-error').textContent = '')
                    .catch(err => document.getElementById('scanner-error').textContent = `無法啟動攝影機: ${err}`);
            }

            function stopScanner() {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().catch(err => console.error("Scanner stop failed", err));
                }
                document.getElementById('stop-scanner-btn').classList.add('hidden');
            }
            document.getElementById('stop-scanner-btn').addEventListener('click', stopScanner);

            async function onScanSuccess(decodedText, decodedResult) {
                if (html5QrCode && html5QrCode.isScanning) html5QrCode.pause();
                
                const residentRef = doc(db, 'communities', selectedCommunityId, 'residents', decodedText);
                const residentSnap = await getDoc(residentRef);

                if (residentSnap.exists()) {
                    const residentData = residentSnap.data();
                    if (residentData.isCheckedIn) {
                        showFeedback('重複報到', `${residentData.householdId} ${residentData.name} 已報到過。`, 'orange');
                        addScanLog(`${residentData.householdId} ${residentData.name}`, '重複報到', 'orange');
                    } else {
                        await updateDoc(residentRef, { isCheckedIn: true, checkInTime: serverTimestamp() });
                        showFeedback('報到成功', `${residentData.householdId} ${residentData.name}`, 'green');
                        addScanLog(`${residentData.householdId} ${residentData.name}`, '報到成功', 'green');
                    }
                } else {
                    showFeedback('無效的 QR Code', '找不到對應的住戶資料。', 'red');
                    addScanLog(`無效的 Code: ${decodedText.substring(0, 8)}...`, '查無資料', 'red');
                }

                setTimeout(() => {
                    if (html5QrCode && html5QrCode.getState && html5QrCode.getState() === 2) { // 2 means PAUSED
                        html5QrCode.resume();
                    }
                }, 2000);
            }

            // Feedback and Log UI
            function showFeedback(title, message, color) {
                const overlay = document.getElementById('feedback-overlay');
                const colors = { green: 'bg-green-500', orange: 'bg-orange-500', red: 'bg-red-500' };
                const icons = { green: 'fa-check-circle', orange: 'fa-exclamation-triangle', red: 'fa-times-circle' };
                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = `feedback-animation text-white p-6 rounded-lg shadow-2xl text-center ${colors[color]}`;
                feedbackDiv.innerHTML = `<i class="fas ${icons[color]} text-5xl mb-3"></i><h3 class="text-2xl font-bold">${title}</h3><p class="text-lg">${message}</p>`;
                overlay.innerHTML = '';
                overlay.appendChild(feedbackDiv);
                setTimeout(() => { if (overlay.contains(feedbackDiv)) overlay.removeChild(feedbackDiv); }, 2800);
            }
            function addScanLog(text, status, color) {
                const logContainer = document.getElementById('scan-log');
                const time = new Date().toLocaleTimeString('zh-TW', { hour12: false });
                const colors = { green: 'border-green-500', orange: 'border-orange-500', red: 'border-red-500' };
                const logEntry = document.createElement('div');
                logEntry.className = `p-2 border-l-4 ${colors[color]} bg-white rounded-r-lg shadow-sm`;
                logEntry.innerHTML = `<div class="flex justify-between items-center"><span class="font-medium text-gray-800">${text}</span><span class="text-xs text-gray-500">${time}</span></div><p class="text-sm text-gray-600">${status}</p>`;
                logContainer.prepend(logEntry);
                if (logContainer.children.length > 50) logContainer.removeChild(logContainer.lastChild);
            }

            // Modal Logic
            const qrModal = document.getElementById('qrcode-modal');
            document.getElementById('view-qrcodes-btn').addEventListener('click', () => qrModal.classList.remove('hidden'));
            document.getElementById('close-qrcode-modal-btn').addEventListener('click', () => qrModal.classList.add('hidden'));
            document.getElementById('print-qrcodes-btn').addEventListener('click', () => window.print());

            let confirmResolve = null;
            const confirmModal = document.getElementById('confirm-modal');
            function showConfirmModal(title, text, confirmText) {
                return new Promise((resolve) => {
                    document.getElementById('confirm-modal-title').textContent = title;
                    document.getElementById('confirm-modal-text').textContent = text;
                    document.getElementById('confirm-modal-ok-btn').textContent = confirmText;
                    confirmModal.classList.remove('hidden');
                    confirmResolve = resolve;
                });
            }
            document.getElementById('confirm-modal-ok-btn').addEventListener('click', () => { confirmModal.classList.add('hidden'); if(confirmResolve) confirmResolve(true); });
            document.getElementById('confirm-modal-cancel-btn').addEventListener('click', () => { confirmModal.classList.add('hidden'); if(confirmResolve) confirmResolve(false); });
            
            const infoModal = document.getElementById('info-modal');
            function showInfoModal(title, text) {
                document.getElementById('info-modal-title').textContent = title;
                document.getElementById('info-modal-text').textContent = text;
                infoModal.classList.remove('hidden');
            }
            document.getElementById('info-modal-ok-btn').addEventListener('click', () => { infoModal.classList.add('hidden'); });
        }
    </script>
</body>
</html>
