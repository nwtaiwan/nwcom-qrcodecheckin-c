<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>社區住戶報到系統 - 管理後台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        .qrcode-item img { margin: 0 auto; }
        @media print {
            body * { visibility: hidden; }
            #qrcode-print-area, #qrcode-print-area * { visibility: visible; }
            #qrcode-print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="w-full max-w-7xl mx-auto p-4 md:p-8">
        <!-- 頁首 -->
        <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8 mb-8 no-print">
            <h1 class="text-3xl md:text-4xl font-bold text-center text-indigo-600">社區住戶報到系統 - 管理後台</h1>
            <p class="text-center text-gray-500 mt-2">即時監控住戶報到狀態與統計數據</p>
        </div>

        <!-- 主內容區 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- 左側: 統計儀表板 -->
            <div class="lg:col-span-1 space-y-6 no-print">
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">即時報到統計</h2>
                    <!-- 戶數統計 -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-500">報到戶數</label>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                            <div id="progress-residents" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <p class="text-right text-lg font-semibold mt-1"><span id="checked-in-residents">0</span> / <span id="total-residents">0</span> 戶 (<span id="percentage-residents">0%</span>)</p>
                    </div>
                    <!-- 坪數統計 -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-500">報到坪數</label>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                            <div id="progress-area" class="bg-teal-500 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <p class="text-right text-lg font-semibold mt-1"><span id="checked-in-area">0.00</span> / <span id="total-area">0.00</span> 坪 (<span id="percentage-area">0%</span>)</p>
                    </div>
                    <!-- 區分權比例統計 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-500">區分權比例</label>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                            <div id="progress-ratio" class="bg-amber-500 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <p class="text-right text-lg font-semibold mt-1"><span id="checked-in-ratio">0</span> / <span id="total-ratio">0</span> (<span id="percentage-ratio">0%</span>)</p>
                    </div>
                </div>
                 <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">管理工具</h2>
                    <button onclick="window.print()" class="w-full bg-gray-700 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition">
                        列印 QR Code
                    </button>
                </div>
            </div>

            <!-- 右側: 住戶報到列表 -->
            <div class="lg:col-span-2 bg-white rounded-2xl shadow-lg p-6 no-print">
                <h2 class="text-xl font-bold text-gray-800 mb-4">住戶報到狀態列表</h2>
                <div class="overflow-y-auto h-[60vh] pr-2">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="p-3 text-sm font-semibold">狀態</th>
                                <th class="p-3 text-sm font-semibold">戶號</th>
                                <th class="p-3 text-sm font-semibold">姓名</th>
                                <th class="p-3 text-sm font-semibold">報到時間</th>
                            </tr>
                        </thead>
                        <tbody id="resident-list">
                            <!-- 住戶資料會顯示在這裡 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 用於生成和列印的 QR Code 區域 -->
        <div id="qrcode-print-area" class="mt-8">
             <h1 class="text-2xl font-bold text-center mb-6">社區住戶報到 QR Code</h1>
             <div id="qrcode-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                <!-- QR Codes will be generated here -->
             </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase 設定 ---
        const firebaseConfig = {
  apiKey: "AIzaSyA66MZ0dfxSrWgtCiIyNW4GjTo0n1s7psg",
  authDomain: "nwcom-qrcodecheckin.firebaseapp.com",
  projectId: "nwcom-qrcodecheckin",
  storageBucket: "nwcom-qrcodecheckin.firebasestorage.app",
  messagingSenderId: "700787049117",
  appId: "1:700787049117:web:13ccf14c5c41abff6b4a74",
  measurementId: "G-E857BJVJMD"
};

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- 應用程式設定 ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-community-app';
        const meetingId = 'annual-meeting-2025';
        const collectionPath = `/artifacts/${appId}/public/data/community-meetings/${meetingId}/residents`;
        
        // --- 範例住戶資料 ---
        const sampleResidents = [
            { residentId: "A001ADDT", householdNum: "A-101", name: "王大明", address: "幸福路一段1號1樓", area: 50.5, ratioNumerator: 125, ratioDenominator: 10000 },
            { residentId: "A002ADDT", householdNum: "A-102", name: "陳淑芬", address: "幸福路一段1號2樓", area: 48.2, ratioNumerator: 119, ratioDenominator: 10000 },
            { residentId: "A003ADDT", householdNum: "B-201", name: "林建宏", address: "快樂街二段2號1樓", area: 65.0, ratioNumerator: 180, ratioDenominator: 10000 },
            { residentId: "A004ADDT", householdNum: "C-301", name: "張美玲", address: "快樂街二段3號1樓", area: 33.7, ratioNumerator: 95, ratioDenominator: 10000 },
            { residentId: "A005ADDT", householdNum: "C-302", name: "李文雄", address: "快樂街二段3號2樓", area: 72.1, ratioNumerator: 210, ratioDenominator: 10000 },
            { residentId: "A006ADDT", householdNum: "D-401", name: "吳秀蘭", address: "美滿巷4弄4號", area: 55.5, ratioNumerator: 140, ratioDenominator: 10000 },
        ];
        
        // --- 初始化資料庫 ---
        async function setupInitialData() {
            const residentsRef = collection(db, collectionPath);
            const snapshot = await getDocs(residentsRef);
            if (snapshot.empty) {
                console.log("資料庫為空，正在寫入範例資料...");
                const batch = writeBatch(db);
                sampleResidents.forEach(resident => {
                    const docRef = doc(db, collectionPath, resident.residentId);
                    batch.set(docRef, { ...resident, isCheckedIn: false, checkinTimestamp: null });
                });
                await batch.commit();
                console.log("範例資料寫入完成。");
            } else {
                console.log("資料庫已有資料，無需初始化。");
            }
            generateQRCodesForPrint(snapshot.docs.length > 0 ? snapshot.docs.map(d => d.data()) : sampleResidents);
        }

        // --- 生成 QR Code 供列印 ---
        function generateQRCodesForPrint(residents) {
            const list = document.getElementById('qrcode-list');
            list.innerHTML = '';
            const baseUrl = window.location.origin + window.location.pathname.replace('admin.html', 'index.html');
            
            residents.forEach(res => {
                const checkinUrl = `${baseUrl}?meeting=${meetingId}&resident=${res.residentId}`;
                const item = document.createElement('div');
                item.className = "qrcode-item border p-2 rounded-lg text-center bg-white";
                
                const info = document.createElement('p');
                info.className = "font-semibold text-sm";
                info.textContent = `${res.householdNum} ${res.name}`;
                
                const qrDiv = document.createElement('div');
                qrDiv.className = "mt-1";

                item.appendChild(info);
                item.appendChild(qrDiv);
                list.appendChild(item);

                new QRCode(qrDiv, {
                    text: checkinUrl,
                    width: 128,
                    height: 128,
                    correctLevel: QRCode.CorrectLevel.H
                });
            });
        }
        
        // --- 即時監聽報到資料並更新儀表板 ---
        function setupRealtimeListener() {
            onSnapshot(collection(db, collectionPath), (snapshot) => {
                let totalRes = 0, checkedInRes = 0;
                let totalAr = 0, checkedInAr = 0;
                let totalRa = 0, checkedInRa = 0, denominator = 1;

                const allResidents = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    allResidents.push(data);

                    totalRes++;
                    totalAr += data.area;
                    totalRa += data.ratioNumerator;
                    denominator = data.ratioDenominator; // 假設所有分母都相同

                    if (data.isCheckedIn) {
                        checkedInRes++;
                        checkedInAr += data.area;
                        checkedInRa += data.ratioNumerator;
                    }
                });
                
                // 更新統計數據
                document.getElementById('total-residents').textContent = totalRes;
                document.getElementById('checked-in-residents').textContent = checkedInRes;
                const percRes = totalRes > 0 ? (checkedInRes / totalRes * 100).toFixed(1) : 0;
                document.getElementById('percentage-residents').textContent = `${percRes}%`;
                document.getElementById('progress-residents').style.width = `${percRes}%`;

                document.getElementById('total-area').textContent = totalAr.toFixed(2);
                document.getElementById('checked-in-area').textContent = checkedInAr.toFixed(2);
                const percArea = totalAr > 0 ? (checkedInAr / totalAr * 100).toFixed(1) : 0;
                document.getElementById('percentage-area').textContent = `${percArea}%`;
                document.getElementById('progress-area').style.width = `${percArea}%`;
                
                document.getElementById('total-ratio').textContent = totalRa;
                document.getElementById('checked-in-ratio').textContent = checkedInRa;
                const percRatio = totalRa > 0 ? (checkedInRa / totalRa * 100).toFixed(1) : 0;
                document.getElementById('percentage-ratio').textContent = `${percRatio}%`;
                document.getElementById('progress-ratio').style.width = `${percRatio}%`;

                // 更新住戶列表
                const list = document.getElementById('resident-list');
                list.innerHTML = '';
                allResidents.sort((a,b) => a.householdNum.localeCompare(b.householdNum)).forEach(data => {
                    const row = document.createElement('tr');
                    row.className = data.isCheckedIn ? 'bg-green-100' : 'bg-white';
                    
                    const time = data.checkinTimestamp ? new Date(data.checkinTimestamp.seconds * 1000).toLocaleTimeString('zh-TW') : '---';
                    
                    row.innerHTML = `
                        <td class="p-3"><span class="px-2 py-1 text-xs font-semibold rounded-full ${data.isCheckedIn ? 'bg-green-200 text-green-800' : 'bg-gray-200 text-gray-800'}">${data.isCheckedIn ? '已報到' : '未報到'}</span></td>
                        <td class="p-3 font-medium">${data.householdNum}</td>
                        <td class="p-3">${data.name}</td>
                        <td class="p-3 text-gray-500">${time}</td>
                    `;
                    list.appendChild(row);
                });
                
                // 初次載入時生成QR Code
                 if (document.getElementById('qrcode-list').innerHTML === '') {
                    generateQRCodesForPrint(allResidents);
                }
            }, (error) => {
                console.error("Firestore snapshot error:", error);
                 const list = document.getElementById('resident-list');
                 list.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-500">無法讀取住戶列表。(${error.message})</td></tr>`;
            });
        }

        // --- 啟動應用 ---
        async function initializeAppAndAuth() {
            try {
                // Sign in to get permissions
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }

                // Now that we are authenticated, setup listener and initial data
                setupRealtimeListener();
                await setupInitialData();
                
            } catch (error) {
                console.error("Authentication or initialization failed:", error);
                const mainContainer = document.querySelector('.w-full.max-w-7xl');
                mainContainer.innerHTML = `<div class="text-center text-red-600 bg-red-100 border border-red-400 rounded-lg p-8">
                    <h2 class="text-xl font-bold">系統連線失敗</h2>
                    <p class="mt-2">無法連接到後台服務，請檢查您的網路連線或聯繫管理員。</p>
                    <p class="mt-1 text-sm text-gray-600">錯誤訊息: ${error.message}</p>
                </div>`;
            }
        }

        initializeAppAndAuth();
    </script>
</body>
</html>
